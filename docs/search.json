[
  {
    "objectID": "ss3.html#a-brief-intro-to-multi--or-n-dimensional-datasets",
    "href": "ss3.html#a-brief-intro-to-multi--or-n-dimensional-datasets",
    "title": "Part 3: Exploring remotely-stored Zarr datasets using Xarray",
    "section": "A brief intro to multi- or N-dimensional datasets",
    "text": "A brief intro to multi- or N-dimensional datasets\nMulti- or N-dimensional geospatial data refers to datasets that include multiple layers or dimensions of geographical information. This data goes beyond the simple two-dimensional latitude and longitude (or y and x) coordinates we have seen in the earlier notebooks and often includes additional dimensions such as time, elevation (altitude or depth), and other variables like temperature, humidity, rainfall.\nThis notebook was designed for a session as part of the UKCEH Summer School. It does not cover all aspects of multi-dimensional data use by the Python scientific communities. Additional resources can be found throughout the notebook."
  },
  {
    "objectID": "ss3.html#contents",
    "href": "ss3.html#contents",
    "title": "Part 3: Exploring remotely-stored Zarr datasets using Xarray",
    "section": "Contents",
    "text": "Contents\n\nLoading N-dimensional datasets from object storage\nUsing Xarray with Dask to explore N-dimensional datasets\nPlotting N-dimensional datasets with Xarray and matplotlib\nComputing a climatology\nUsing shapefiles to “cut-out” areas of N-dimensional datasets\n\nImport packages\n\n# ONLY NEEDS TO BE RUN IF USING GOOGLE COLABS\n#!pip install s3fs cartopy zarr boto3 netcdf4 rasterio\n\n\nimport os\nimport s3fs\nimport boto3\nimport xarray as xr\nimport numpy as np\nimport cartopy as cp\nimport geopandas as gpd\nfrom dask.diagnostics import ProgressBar\nimport matplotlib.pyplot as plt\nimport matplotlib.animation as animation\nimport datetime\nimport zarr\n\nIn this notebook we will explore how to work with gridded N-dimensional datasets stored remotely. Specifically we will be looking at datasets stored as Zarr, which is a format becoming increasingly common in big-data science where datasets need to be stored in remote “object stores” due to their size.\nNetCDF is another very common format for gridded N-dimensional datasets. Whilst we will not explicitly work with NetCDF data here, once data is read into Xarray it behaves in the same way and the same commands can be used.\n\nAccess and explore the datasets in object store buckets (using FSSpec and Xarray)\nWe will be working with an hourly gridded rainfall dataset - UKCEH GEAR\nFor publically available data such as this, we do not need any credentials, and instead pass anon=True which means ‘access the data as an anonymous user’.\nWe will use the FSSpec package, which basically has the ability to take any data stored on any storage system and make it look as if the data is on an ordinary disk to the rest of your code. The idea is that you run this bit of code once and then it gets out the way and lets you continue your coding as if the data was still on disk and not in a remote object store in the cloud.\nTo make it work we provide anon=True and the endpoint_url, but also the path to the specific dataset we want to use:\nNote: There are two ways of doing this, depending on which version of the Zarr package is installed in your python environment. To check, run:\n\nzarr.__version__\n\n'3.1.5'\n\n\n\n# zarr v2 method\n#zstore = fsspec.get_mapper('s3://gearhrly/gearhrly_fulloutput_yearly_100km_chunks.zarr',\n#                           anon=True,\n#                           endpoint_url=\"https://fdri-o.s3-ext.jc.rl.ac.uk\")\n\n# zarr v3 method\nfs = s3fs.S3FileSystem(anon=True, asynchronous=True, endpoint_url=\"https://fdri-o.s3-ext.jc.rl.ac.uk\")\nzstore = zarr.storage.FsspecStore(fs, path=\"gearhrly/gearhrly_15day_100km_chunks.zarr\")\n\nWe then pass the created file-system-like object to Xarray, and from here on in Xarray behaves as if the data were stored locally on disk, and we can largely forget about the fact that it’s actually stored remotely in the cloud.\n\nds = xr.open_zarr(zstore, consolidated=True)\n\nNext let’s explore the dataset a bit.\n\nds\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&lt;xarray.Dataset&gt; Size: 5TB\nDimensions:          (time: 236688, y: 1251, x: 701, bnds: 2)\nCoordinates:\n  * time             (time) datetime64[ns] 2MB 1990-01-01 ... 2016-12-31T23:0...\n  * y                (y) float64 10kB 1.25e+06 1.249e+06 1.248e+06 ... 1e+03 0.0\n  * x                (x) float64 6kB 0.0 1e+03 2e+03 ... 6.98e+05 6.99e+05 7e+05\n    lat              (y, x) float64 7MB dask.array&lt;chunksize=(100, 100), meta=np.ndarray&gt;\n    lon              (y, x) float64 7MB dask.array&lt;chunksize=(100, 100), meta=np.ndarray&gt;\n    time_bnds        (time, bnds) datetime64[ns] 4MB dask.array&lt;chunksize=(360, 2), meta=np.ndarray&gt;\n    x_bnds           (x, bnds) float64 11kB dask.array&lt;chunksize=(100, 2), meta=np.ndarray&gt;\n    y_bnds           (y, bnds) float64 20kB dask.array&lt;chunksize=(100, 2), meta=np.ndarray&gt;\n    crs              int16 2B ...\nDimensions without coordinates: bnds\nData variables:\n    min_dist         (time, y, x) float64 2TB dask.array&lt;chunksize=(360, 100, 100), meta=np.ndarray&gt;\n    rainfall_amount  (time, y, x) float64 2TB dask.array&lt;chunksize=(360, 100, 100), meta=np.ndarray&gt;\n    stat_disag       (time, y, x) float64 2TB dask.array&lt;chunksize=(360, 100, 100), meta=np.ndarray&gt;\nAttributes: (12/29)\n    Conventions:                   CF-1.6\n    acknowledgement:               This research forms part of the SINATRA pr...\n    cdm_data_type:                 Grid\n    contributor_name:              Lewis, E., Quinn, N., Blenkinsop, S., Fowl...\n    creator_email:                 enquiries@ceh.ac.uk\n    creator_institution:           UK Centre for Ecology & Hydrology (UKCEH)\n    ...                            ...\n    standard_name_vocabulary:      CF Standard Name Table v70, http://cfconve...\n    summary:                       The CEH-GEAR1hr-v2 dataset contains 1-km g...\n    time_coverage_duration:        P27Y\n    time_coverage_resolution:      P1H\n    title:                         Gridded estimates of hourly areal rainfall...\n    version:                       v2xarray.DatasetDimensions:time: 236688y: 1251x: 701bnds: 2Coordinates: (9)time(time)datetime64[ns]1990-01-01 ... 2016-12-31T23:00:00bounds :time_bndslong_name :Time in hours since 1980-1-1 0:0:0 UTCarray(['1990-01-01T00:00:00.000000000', '1990-01-01T01:00:00.000000000',\n       '1990-01-01T02:00:00.000000000', ..., '2016-12-31T21:00:00.000000000',\n       '2016-12-31T22:00:00.000000000', '2016-12-31T23:00:00.000000000'],\n      shape=(236688,), dtype='datetime64[ns]')y(y)float641.25e+06 1.249e+06 ... 1e+03 0.0bounds :y_bndslong_name :northing - OSGB36 grid referencepoint_spacing :evenstandard_name :projection_y_coordinateunits :marray([1.250e+06, 1.249e+06, 1.248e+06, ..., 2.000e+03, 1.000e+03, 0.000e+00],\n      shape=(1251,))x(x)float640.0 1e+03 2e+03 ... 6.99e+05 7e+05bounds :x_bndslong_name :easting - OSGB36 grid referencepoint_spacing :evenstandard_name :projection_x_coordinateunits :marray([     0.,   1000.,   2000., ..., 698000., 699000., 700000.], shape=(701,))lat(y, x)float64dask.array&lt;chunksize=(100, 100), meta=np.ndarray&gt;long_name :latitudestandard_name :latitudeunits :degrees_north\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n6.69 MiB\n78.12 kiB\n\n\nShape\n(1251, 701)\n(100, 100)\n\n\nDask graph\n104 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                            701 1251\n\n\n\n\nlon(y, x)float64dask.array&lt;chunksize=(100, 100), meta=np.ndarray&gt;long_name :longitudestandard_name :longitudeunits :degrees_east\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n6.69 MiB\n78.12 kiB\n\n\nShape\n(1251, 701)\n(100, 100)\n\n\nDask graph\n104 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                            701 1251\n\n\n\n\ntime_bnds(time, bnds)datetime64[ns]dask.array&lt;chunksize=(360, 2), meta=np.ndarray&gt;\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n3.61 MiB\n5.62 kiB\n\n\nShape\n(236688, 2)\n(360, 2)\n\n\nDask graph\n658 chunks in 2 graph layers\n\n\nData type\ndatetime64[ns] numpy.ndarray\n\n\n\n\n                           2 236688\n\n\n\n\nx_bnds(x, bnds)float64dask.array&lt;chunksize=(100, 2), meta=np.ndarray&gt;\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n10.95 kiB\n1.56 kiB\n\n\nShape\n(701, 2)\n(100, 2)\n\n\nDask graph\n8 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                2 701\n\n\n\n\ny_bnds(y, bnds)float64dask.array&lt;chunksize=(100, 2), meta=np.ndarray&gt;\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n19.55 kiB\n1.56 kiB\n\n\nShape\n(1251, 2)\n(100, 2)\n\n\nDask graph\n13 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                     2 1251\n\n\n\n\ncrs()int16...EPSG_code :EPSG:27700false_easting :400000.0false_northing :-100000.0geographic_coordinate_system_name :OSGB 1936grid_mapping_name :transverse_mercatorhorizontal_datum_name :OSGB_1936inverse_flattening :299.3249646latitude_of_projection_origin :49.0longitude_of_central_meridian :-2.0longitude_of_prime_meridian :0.0prime_meridian_name :Greenwichprojected_coordinate_system_name :OSGB 1936 / British National Gridreference_ellipsoid_name :Airy 1830scale_factor_at_projection_origin :0.9996012717semi_major_axis :6377563.396towgs84 :[375.0, -111.0, 431.0, 0.0, 0.0, 0.0, 0.0]unit :m[1 values with dtype=int16]Data variables: (3)min_dist(time, y, x)float64dask.array&lt;chunksize=(360, 100, 100), meta=np.ndarray&gt;comment :The minimum distance corresponds to the distance to the closest raingauge used in the nearest neighbour method to estimate the normalised hourly rainfall amount in a grid cell. This distance provides an indicator of accuracy/confidence in the estimated rainfall amount. As the minimum distance increases so does uncertainty in the rainfall estimates. Users should be cautious when using the rainfall data in areas where the minimum distance is large, as the estimates are most likely less reliable. Where min_dist &gt; 50km, rainfall estimates are not produced and statistical disaggregation is used instead.long_name :Minimum distanceunits :mvalid_max :100000.0valid_min :0.0\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n1.51 TiB\n27.47 MiB\n\n\nShape\n(236688, 1251, 701)\n(360, 100, 100)\n\n\nDask graph\n68432 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                                                                                                   701 1251 236688\n\n\n\n\nrainfall_amount(time, y, x)float64dask.array&lt;chunksize=(360, 100, 100), meta=np.ndarray&gt;grid_mapping :crslong_name :Gridded estimates of hourly rainfallstandard_name :rainfall_amountunits :kg m-2valid_max :500.0valid_min :0.0\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n1.51 TiB\n27.47 MiB\n\n\nShape\n(236688, 1251, 701)\n(360, 100, 100)\n\n\nDask graph\n68432 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                                                                                                   701 1251 236688\n\n\n\n\nstat_disag(time, y, x)float64dask.array&lt;chunksize=(360, 100, 100), meta=np.ndarray&gt;comment :Statistical disaggregation, based on an average storm shape for a given daily rainfall total, is used when a grid square is greater than 50km from a gauge, or when there is rainfall in the daily record but not in the hourly record. Users should be cautious when using the rainfall data in areas where statistical disaggregation is used, as the estimates are most likely less reliable. Flag value 1 indicates where statistical disaggregation of the daily total was used instead of a real storm shape from the nearest gauge.flag_meanings :no_statistical_disaggregation_used   statistical_disaggregation_usedflag_values :0,  1long_name :Statistical disaggregationunits :valid_max :1valid_min :0\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n1.51 TiB\n27.47 MiB\n\n\nShape\n(236688, 1251, 701)\n(360, 100, 100)\n\n\nDask graph\n68432 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                                                                                                   701 1251 236688\n\n\n\n\nAttributes: (29)Conventions :CF-1.6acknowledgement :This research forms part of the SINATRA project which is supported by the United Kingdom NERC Flooding from Intense Rainfall programme (grant NE/K00896X/1) and an associated knowledge exchange award. It was also funded as part of the CONVEX project which was supported by the United Kingdom NERC Changing Water Cycle programme (grant NE/I006680/1) and the INTENSE project through the European Research Council (grant ERC-2013-CoG-617329). The update of CEH-GEAR-1hr (version 2) was funded by NERC Hydro?JULES programme (grant NE/S017380/1)cdm_data_type :Gridcontributor_name :Lewis, E., Quinn, N., Blenkinsop, S., Fowler, H.J., Freer, J., Tanguy, M., Hitt, O., Coxon, G., Bates, P., Woods, R., Fry, M., Chevuturi, A., Swain, O., White, S.M.creator_email :enquiries@ceh.ac.ukcreator_institution :UK Centre for Ecology & Hydrology (UKCEH)creator_name :Tanguy, M.geospatial_lat_max :61.026796geospatial_lat_min :49.766807geospatial_lon_max :3.554013geospatial_lon_min :-7.55716id :https://doi.org/10.5285/fc9423d6-3d54-467f-bb2b-fc7357a3941finstitution :Newcastle Universitykeywords :rainfall, precipitation, nearest neighbour interpolation, flood, storm, sub-daily, hourlylicence :This dataset is available under the terms of the Open Government Licence https://eidc.ceh.ac.uk/licences/OGL/plainmetadata_link :naming_authority :DataCITEpublisher_institution :NERC Environmental Information Data Centrereferences :Elizabeth Lewis, Niall Quinn, Stephen Blenkinsop, Hayley J. Fowler, Jim Freer, Maliko Tanguy, Olivia Hitt, Gemma Coxon, Paul Bates, Ross Woods. 2018. A rule based quality control method for hourly rainfall data and a 1km resolution gridded hourly rainfall dataset for Great Britain: CEH-GEAR1hr. Journal of Hydrology, 564, 930-943, https://doi.org/10.1016/j.jhydrol.2018.07.034.source :This dataset has been generated from a number of input datasets. Sub-daily raingauge data from the Met Office, the Scottish Environment Protection Agency (SEPA), the Environment Agency (EA) and Natural Resources Wales (NRW) were used to disaggregate the daily CEH-GEAR rainfall dataset (https://doi.org/10.5285/ee9ab43d-a4fe-4e73-afd5-cd4fc4c82556) into hourly timesteps.spatial_resolution_distance :1000.0spatial_resolution_unit :urn:ogc:def:uom:EPSG::9001standard_name_url_vocabulary :NERC Vocabulary Server, https://vocab.nerc.ac.uk/standard_name/standard_name_vocabulary :CF Standard Name Table v70, http://cfconventions.org/standard-names.htmlsummary :The CEH-GEAR1hr-v2 dataset contains 1-km grids of hourly rainfall estimates for GB for the period 1990-2017. The gridded rainfall estimates are derived by applying the nearest neighbour interpolation method to hourly raingauge observations. These interpolated hourly estimates were then used to temporally disaggregate the daily CEH-GEAR dataset (https://doi.org/10.5285/33604ea0-c238-4488-813d-0ad9ab7c51ca). The dataset also contains, for each day, a grid containing, for each grid point, the distance between the grid point and the closest recording raingauge used in its interpolation.  When this distance is greater than 50 km, or there is 0mm rainfall recorded in the closest gauge the daily value is disaggregated using a design storm. The dataset therefore also contains for each day, a grid containing for each grid point a flag showing if the design storm was used. These grids are provided as an indicator of the quality of the estimates.time_coverage_duration :P27Ytime_coverage_resolution :P1Htitle :Gridded estimates of hourly areal rainfall for Great Britain (1990-2016) - version 2 [CEH-GEAR1hr.v2]version :v2\n\n\nThe variables in the dataset are split into those that describe the coordinates, and those of the main data. We can see the three main data variables: ‘min_dist’, ‘rainfall_amount’ and ‘stat_disag’, you can click the page icon at the end of each variable’s row to find out a little more about each.\nThe names in brackets next to the variable names (the second column of information) show you the dimensions that each variable is on. Here, all our data variables are on a 3D grid of time, y and x.\nYou can see in the Coordinates section that we have other coordinates besides those for the time, y and x dimensions. The lat and lon variables tell you the latitude and longitude conversion for each x,y gridpoint and the ‘xxx_bnds’ variables tell you the extent/valid range of each datapoint. So for example a gridpoint of (6000,6000) on a grid with a resolution of (1000,1000) would have extents/boundaries of (5500,6500) for both x and y, describing the extent of the gridbox this gridpoint represents. The same concept can be extended to the time-dimension too.\n\nfrom PIL import Image\nfs_img = s3fs.S3FileSystem(anon=True, endpoint_url=\"https://fdri-o.s3-ext.jc.rl.ac.uk\")\ndisplay(Image.open(fs_img.open('s3://example-data/Scratch-1.png')))\n\n\n\n\n\n\n\n\nMore information about the dataset is available by clicking on ‘Attributes’ to expand this section\nAll Zarr datasets that follow the CF-Conventions (a format standard for NetCDF, and Zarr by extension, originally created for climate-model data but slowly being expanded out to cover more disciplines in the geosciences) should look similar to this one.\nVariables are selected using datasetname['variablename'] syntax\nThe .data attribute pulls out the underlying data array of the specified variable, which in the case of Zarr will be a Dask array. Dask arrays, as opposed to standard Numpy arrays you might be used to working with, are ‘chunked’ into little parcels of data. It’s a feature of the format that makes it most suitable for storage on the cloud.\n\nds['rainfall_amount'].data\n\n\n\n\n\n\n\n\n\n\n\n\nArray\nChunk\n\n\n\n\nBytes\n1.51 TiB\n27.47 MiB\n\n\nShape\n(236688, 1251, 701)\n(360, 100, 100)\n\n\nDask graph\n68432 chunks in 2 graph layers\n\n\nData type\nfloat64 numpy.ndarray\n\n\n\n\n                                                                                                   701 1251 236688\n\n\n\n\n\n\n\nBytes shows you the overall size of the array and indivdual chunk\nShape shows you the dimension sizes of the array and chunk. This dataset has 236688 time steps!\nDask graph tells you how many tasks (68432 here) would be needed to load the actual data into memory (see below section on Lazy Loading)\nData type tells you what the data inside the array consists of. Here it is a Numpy array containing 64-bit (8-byte) floats (floating-point numbers), which is typical for numeric data.\n\n\n\nComputations and visualisations with Xarray and Dask\n\nAn introduction to Lazy Loading\nBefore we go any further it is very important to know that Xarray loads data lazily. This means that the actual data is never loaded or computed until it absolutely has to be. So you may run some code that computes the mean of the dataset (e.g. dmean = ds['variable'].mean(dim='time')), but the computation will only actually be carried out when you want to see the result of this calculation, e.g. through a plot or print statement, or saving to disk.\nDask also takes this a step further. Dask is a library designed to automatically parallelise computations; parallelisation is essential when dealing with chunked data such as Zarr on the cloud. Dask sits in the background working out how best to parallelise your computations, then whenever Xarray actually triggers a compute, Dask will automatically kick in and process the computation in parallel. However, with Dask, the output of the computation will not persist in memory, even if you save the output to a variable (e.g. dmean = ds['variable'].mean(dim='time')). If you run the code again, Dask will recompute everything from scratch, the actual data is not stored in the variable dmean, rather the Dask-instructions for computing it. This can make code very slow if not handled correctly. The best way to handle this is to make use of Dask’s .persist()and .compute() methods. Appending this on to the end of a calculation, such as dmean = ds['variable'].mean(dim='time').compute() will keep the data in memory.\nThe main difference between persist and compute is that persist will allow you to continue coding whilst dask computes the result in the background, whereas compute will wait until the computation is complete before letting you continue coding. I tend to find compute behaves the most intuitively.\nNow with that out the way let’s get to actually looking at the data!\n\n\nPlot an individual time step\nYou can index the array and pull out a single timestep like you can any standard array-like object in Python\nXarray also adds a plot() method you can call to produce a rough-and-ready quick plot of the data you’ve selected, in this case the 37th timestep of the dataset\n\nwith ProgressBar():\n    ds['rainfall_amount'][36,:,:].plot()\n\n[                                        ] | 0% Completed | 158.71 us[                                        ] | 0% Completed | 105.60 ms[                                        ] | 0% Completed | 206.04 ms[                                        ] | 0% Completed | 306.31 ms[                                        ] | 1% Completed | 406.64 ms[                                        ] | 1% Completed | 507.09 ms[                                        ] | 2% Completed | 607.52 ms[#                                       ] | 2% Completed | 708.02 ms[#                                       ] | 3% Completed | 808.44 ms[#                                       ] | 3% Completed | 908.85 ms[#                                       ] | 3% Completed | 1.01 s[#                                       ] | 3% Completed | 1.11 s[#                                       ] | 3% Completed | 1.21 s[#                                       ] | 4% Completed | 1.31 s[#                                       ] | 4% Completed | 1.41 s[##                                      ] | 5% Completed | 1.51 s[##                                      ] | 5% Completed | 1.61 s[##                                      ] | 6% Completed | 1.71 s[##                                      ] | 6% Completed | 1.81 s[##                                      ] | 6% Completed | 1.91 s[##                                      ] | 6% Completed | 2.01 s[##                                      ] | 7% Completed | 2.11 s[###                                     ] | 7% Completed | 2.22 s[###                                     ] | 8% Completed | 2.32 s[###                                     ] | 8% Completed | 2.42 s[###                                     ] | 8% Completed | 2.52 s[###                                     ] | 8% Completed | 2.62 s[###                                     ] | 8% Completed | 2.72 s[###                                     ] | 8% Completed | 2.82 s[###                                     ] | 8% Completed | 2.92 s[###                                     ] | 8% Completed | 3.02 s[###                                     ] | 8% Completed | 3.12 s[###                                     ] | 9% Completed | 3.22 s[###                                     ] | 9% Completed | 3.32 s[###                                     ] | 9% Completed | 3.42 s[####                                    ] | 10% Completed | 3.52 s[####                                    ] | 10% Completed | 3.62 s[####                                    ] | 11% Completed | 3.72 s[####                                    ] | 11% Completed | 3.82 s[#####                                   ] | 12% Completed | 3.92 s[#####                                   ] | 13% Completed | 4.02 s[#####                                   ] | 13% Completed | 4.12 s[#####                                   ] | 13% Completed | 4.22 s[#####                                   ] | 13% Completed | 4.33 s[#####                                   ] | 13% Completed | 4.43 s[#####                                   ] | 14% Completed | 4.53 s[#####                                   ] | 14% Completed | 4.63 s[#####                                   ] | 14% Completed | 4.73 s[######                                  ] | 15% Completed | 4.83 s[######                                  ] | 15% Completed | 4.93 s[######                                  ] | 16% Completed | 5.03 s[######                                  ] | 16% Completed | 5.13 s[######                                  ] | 17% Completed | 5.23 s[#######                                 ] | 18% Completed | 5.33 s[#######                                 ] | 18% Completed | 5.43 s[#######                                 ] | 18% Completed | 5.53 s[#######                                 ] | 18% Completed | 5.63 s[#######                                 ] | 18% Completed | 5.73 s[#######                                 ] | 18% Completed | 5.83 s[#######                                 ] | 19% Completed | 5.93 s[#######                                 ] | 19% Completed | 6.03 s[#######                                 ] | 19% Completed | 6.13 s[#######                                 ] | 19% Completed | 6.23 s[########                                ] | 20% Completed | 6.33 s[########                                ] | 20% Completed | 6.43 s[########                                ] | 21% Completed | 6.53 s[########                                ] | 21% Completed | 6.64 s[########                                ] | 21% Completed | 6.74 s[########                                ] | 21% Completed | 6.84 s[########                                ] | 21% Completed | 6.94 s[########                                ] | 22% Completed | 7.04 s[########                                ] | 22% Completed | 7.14 s[#########                               ] | 22% Completed | 7.24 s[#########                               ] | 23% Completed | 7.34 s[#########                               ] | 23% Completed | 7.44 s[#########                               ] | 23% Completed | 7.54 s[#########                               ] | 23% Completed | 7.64 s[#########                               ] | 24% Completed | 7.74 s[#########                               ] | 24% Completed | 7.84 s[#########                               ] | 24% Completed | 7.94 s[#########                               ] | 24% Completed | 8.04 s[#########                               ] | 24% Completed | 8.14 s[#########                               ] | 24% Completed | 8.24 s[#########                               ] | 24% Completed | 8.34 s[#########                               ] | 24% Completed | 8.45 s[##########                              ] | 25% Completed | 8.55 s[##########                              ] | 26% Completed | 8.65 s[##########                              ] | 26% Completed | 8.75 s[##########                              ] | 27% Completed | 8.85 s[###########                             ] | 28% Completed | 8.95 s[###########                             ] | 29% Completed | 9.05 s[###########                             ] | 29% Completed | 9.15 s[############                            ] | 30% Completed | 9.25 s[############                            ] | 30% Completed | 9.35 s[############                            ] | 30% Completed | 9.45 s[############                            ] | 31% Completed | 9.55 s[############                            ] | 32% Completed | 9.65 s[############                            ] | 32% Completed | 9.75 s[#############                           ] | 32% Completed | 9.85 s[#############                           ] | 32% Completed | 9.95 s[#############                           ] | 32% Completed | 10.05 s[#############                           ] | 32% Completed | 10.15 s[#############                           ] | 33% Completed | 10.25 s[#############                           ] | 33% Completed | 10.35 s[#############                           ] | 34% Completed | 10.45 s[#############                           ] | 34% Completed | 10.55 s[#############                           ] | 34% Completed | 10.66 s[#############                           ] | 34% Completed | 10.76 s[#############                           ] | 34% Completed | 10.86 s[##############                          ] | 35% Completed | 10.96 s[##############                          ] | 35% Completed | 11.06 s[##############                          ] | 35% Completed | 11.16 s[##############                          ] | 35% Completed | 11.26 s[##############                          ] | 35% Completed | 11.36 s[##############                          ] | 35% Completed | 11.46 s[##############                          ] | 35% Completed | 11.56 s[##############                          ] | 35% Completed | 11.66 s[##############                          ] | 35% Completed | 11.76 s[##############                          ] | 36% Completed | 11.86 s[##############                          ] | 36% Completed | 11.96 s[##############                          ] | 37% Completed | 12.06 s[##############                          ] | 37% Completed | 12.16 s[##############                          ] | 37% Completed | 12.26 s[###############                         ] | 38% Completed | 12.36 s[###############                         ] | 38% Completed | 12.46 s[###############                         ] | 39% Completed | 12.56 s[################                        ] | 40% Completed | 12.67 s[################                        ] | 40% Completed | 12.77 s[################                        ] | 41% Completed | 12.87 s[################                        ] | 42% Completed | 12.97 s[#################                       ] | 44% Completed | 13.07 s[#################                       ] | 44% Completed | 13.17 s[##################                      ] | 46% Completed | 13.27 s[###################                     ] | 47% Completed | 13.37 s[###################                     ] | 48% Completed | 13.47 s[###################                     ] | 49% Completed | 13.57 s[####################                    ] | 50% Completed | 13.67 s[####################                    ] | 51% Completed | 13.77 s[####################                    ] | 52% Completed | 13.87 s[#####################                   ] | 53% Completed | 13.97 s[######################                  ] | 56% Completed | 14.07 s[#######################                 ] | 58% Completed | 14.17 s[########################                ] | 60% Completed | 14.27 s[#########################               ] | 62% Completed | 14.37 s[#########################               ] | 64% Completed | 14.48 s[##########################              ] | 67% Completed | 14.58 s[###########################             ] | 68% Completed | 14.68 s[############################            ] | 71% Completed | 14.78 s[#############################           ] | 73% Completed | 14.88 s[##############################          ] | 76% Completed | 14.98 s[###############################         ] | 79% Completed | 15.08 s[################################        ] | 81% Completed | 15.18 s[#################################       ] | 84% Completed | 15.28 s[##################################      ] | 87% Completed | 15.38 s[###################################     ] | 89% Completed | 15.48 s[####################################    ] | 92% Completed | 15.58 s[######################################  ] | 95% Completed | 15.68 s[####################################### ] | 97% Completed | 15.78 s[####################################### ] | 99% Completed | 15.88 s[####################################### ] | 99% Completed | 15.98 s[####################################### ] | 99% Completed | 16.08 s[########################################] | 100% Completed | 16.18 s\n\n\n\n\n\n\n\n\n\n\n\nCustomising plots\nThese plots can be customised to look nicer too. Note that we’re making use of Dask’s compute() method to save the variable plotpoint in memory, so that we don’t have to rerun the processing needed to extract this point from the cloud whenever we rerun the plotting commands:\n\nwith ProgressBar():\n    plotpoint = ds['rainfall_amount'][36,:,:].compute()\n\n[                                        ] | 0% Completed | 170.40 us[                                        ] | 0% Completed | 100.84 ms[                                        ] | 1% Completed | 201.37 ms[                                        ] | 1% Completed | 301.87 ms[                                        ] | 1% Completed | 402.36 ms[#                                       ] | 2% Completed | 502.99 ms[#                                       ] | 2% Completed | 603.59 ms[#                                       ] | 2% Completed | 704.21 ms[#                                       ] | 3% Completed | 804.92 ms[#                                       ] | 3% Completed | 905.34 ms[#                                       ] | 3% Completed | 1.01 s[#                                       ] | 4% Completed | 1.11 s[#                                       ] | 4% Completed | 1.21 s[#                                       ] | 4% Completed | 1.31 s[#                                       ] | 4% Completed | 1.41 s[##                                      ] | 5% Completed | 1.51 s[##                                      ] | 5% Completed | 1.61 s[##                                      ] | 5% Completed | 1.71 s[##                                      ] | 5% Completed | 1.81 s[##                                      ] | 6% Completed | 1.91 s[##                                      ] | 6% Completed | 2.01 s[##                                      ] | 7% Completed | 2.11 s[###                                     ] | 7% Completed | 2.21 s[###                                     ] | 7% Completed | 2.31 s[###                                     ] | 8% Completed | 2.41 s[###                                     ] | 9% Completed | 2.51 s[###                                     ] | 9% Completed | 2.61 s[####                                    ] | 10% Completed | 2.71 s[####                                    ] | 10% Completed | 2.81 s[####                                    ] | 10% Completed | 2.91 s[####                                    ] | 10% Completed | 3.01 s[####                                    ] | 10% Completed | 3.11 s[####                                    ] | 10% Completed | 3.22 s[####                                    ] | 11% Completed | 3.32 s[####                                    ] | 11% Completed | 3.42 s[#####                                   ] | 13% Completed | 3.52 s[#####                                   ] | 13% Completed | 3.62 s[#####                                   ] | 13% Completed | 3.72 s[#####                                   ] | 13% Completed | 3.82 s[#####                                   ] | 13% Completed | 3.92 s[#####                                   ] | 13% Completed | 4.02 s[#####                                   ] | 13% Completed | 4.12 s[#####                                   ] | 14% Completed | 4.22 s[#####                                   ] | 14% Completed | 4.32 s[#####                                   ] | 14% Completed | 4.42 s[#####                                   ] | 14% Completed | 4.52 s[######                                  ] | 15% Completed | 4.62 s[######                                  ] | 15% Completed | 4.72 s[######                                  ] | 16% Completed | 4.82 s[######                                  ] | 17% Completed | 4.92 s[######                                  ] | 17% Completed | 5.02 s[#######                                 ] | 17% Completed | 5.13 s[#######                                 ] | 18% Completed | 5.23 s[#######                                 ] | 18% Completed | 5.33 s[#######                                 ] | 18% Completed | 5.43 s[#######                                 ] | 18% Completed | 5.53 s[#######                                 ] | 18% Completed | 5.63 s[#######                                 ] | 18% Completed | 5.73 s[#######                                 ] | 19% Completed | 5.83 s[#######                                 ] | 19% Completed | 5.93 s[#######                                 ] | 19% Completed | 6.03 s[#######                                 ] | 19% Completed | 6.13 s[#######                                 ] | 19% Completed | 6.23 s[#######                                 ] | 19% Completed | 6.33 s[#######                                 ] | 19% Completed | 6.43 s[########                                ] | 20% Completed | 6.53 s[########                                ] | 20% Completed | 6.63 s[########                                ] | 21% Completed | 6.73 s[########                                ] | 21% Completed | 6.83 s[########                                ] | 21% Completed | 6.93 s[########                                ] | 21% Completed | 7.04 s[########                                ] | 21% Completed | 7.14 s[########                                ] | 21% Completed | 7.24 s[########                                ] | 21% Completed | 7.34 s[########                                ] | 21% Completed | 7.44 s[########                                ] | 21% Completed | 7.54 s[########                                ] | 22% Completed | 7.64 s[########                                ] | 22% Completed | 7.74 s[########                                ] | 22% Completed | 7.84 s[#########                               ] | 22% Completed | 7.94 s[#########                               ] | 22% Completed | 8.04 s[#########                               ] | 23% Completed | 8.14 s[#########                               ] | 23% Completed | 8.24 s[#########                               ] | 24% Completed | 8.34 s[#########                               ] | 24% Completed | 8.44 s[#########                               ] | 24% Completed | 8.54 s[#########                               ] | 24% Completed | 8.64 s[##########                              ] | 25% Completed | 8.74 s[##########                              ] | 25% Completed | 8.84 s[##########                              ] | 25% Completed | 8.94 s[##########                              ] | 25% Completed | 9.04 s[##########                              ] | 25% Completed | 9.14 s[##########                              ] | 26% Completed | 9.25 s[##########                              ] | 26% Completed | 9.35 s[##########                              ] | 26% Completed | 9.45 s[##########                              ] | 26% Completed | 9.55 s[###########                             ] | 28% Completed | 9.65 s[###########                             ] | 28% Completed | 9.75 s[###########                             ] | 29% Completed | 9.85 s[############                            ] | 30% Completed | 9.95 s[############                            ] | 30% Completed | 10.05 s[############                            ] | 31% Completed | 10.15 s[############                            ] | 31% Completed | 10.25 s[############                            ] | 32% Completed | 10.35 s[############                            ] | 32% Completed | 10.45 s[############                            ] | 32% Completed | 10.55 s[############                            ] | 32% Completed | 10.65 s[#############                           ] | 32% Completed | 10.75 s[#############                           ] | 32% Completed | 10.85 s[#############                           ] | 32% Completed | 10.95 s[#############                           ] | 32% Completed | 11.05 s[#############                           ] | 33% Completed | 11.15 s[#############                           ] | 33% Completed | 11.25 s[#############                           ] | 33% Completed | 11.35 s[#############                           ] | 34% Completed | 11.45 s[#############                           ] | 34% Completed | 11.56 s[##############                          ] | 35% Completed | 11.66 s[##############                          ] | 36% Completed | 11.76 s[##############                          ] | 36% Completed | 11.86 s[##############                          ] | 36% Completed | 11.96 s[##############                          ] | 36% Completed | 12.06 s[##############                          ] | 36% Completed | 12.16 s[##############                          ] | 37% Completed | 12.26 s[##############                          ] | 37% Completed | 12.36 s[###############                         ] | 39% Completed | 12.46 s[################                        ] | 40% Completed | 12.56 s[################                        ] | 41% Completed | 12.66 s[################                        ] | 41% Completed | 12.76 s[################                        ] | 42% Completed | 12.86 s[#################                       ] | 42% Completed | 12.96 s[##################                      ] | 45% Completed | 13.06 s[##################                      ] | 47% Completed | 13.16 s[###################                     ] | 48% Completed | 13.26 s[###################                     ] | 49% Completed | 13.36 s[####################                    ] | 50% Completed | 13.46 s[####################                    ] | 52% Completed | 13.56 s[#####################                   ] | 53% Completed | 13.66 s[#####################                   ] | 54% Completed | 13.76 s[######################                  ] | 56% Completed | 13.87 s[#######################                 ] | 57% Completed | 13.97 s[#######################                 ] | 59% Completed | 14.07 s[########################                ] | 62% Completed | 14.17 s[##########################              ] | 65% Completed | 14.27 s[###########################             ] | 68% Completed | 14.37 s[############################            ] | 70% Completed | 14.47 s[#############################           ] | 72% Completed | 14.57 s[#############################           ] | 74% Completed | 14.67 s[###############################         ] | 77% Completed | 14.77 s[################################        ] | 80% Completed | 14.87 s[#################################       ] | 82% Completed | 14.97 s[#################################       ] | 84% Completed | 15.07 s[###################################     ] | 87% Completed | 15.17 s[###################################     ] | 89% Completed | 15.27 s[#####################################   ] | 92% Completed | 15.37 s[######################################  ] | 95% Completed | 15.47 s[####################################### ] | 98% Completed | 15.57 s[########################################] | 100% Completed | 15.68 s\n\n\n\nplotpoint.plot.pcolormesh('lon', 'lat', cmap='Blues', robust=True)\nplt.title(r'Rainfall $2^{nd}$ Jan 1990 12:00')\n\nText(0.5, 1.0, 'Rainfall $2^{nd}$ Jan 1990 12:00')\n\n\n\n\n\n\n\n\n\nHere we have: - changed the axes to use lon/lat instead of x/y coordinates by specifying the dataset name of the longitude and latitude variables in the plotting command - changed the colourmap to a nicer one (all pre-built colourmaps can be found at https://matplotlib.org/3.1.0/tutorials/colors/colormaps.html) - changed the title to better describe the data being plotted - used Xarray’s ‘robust’ option, which modifies the colourbar to not stretch to the maximum of the data if it is an outlier. This stops a small area of very high values dominating the colourbar and making other variation invisible\nBut it would also be nice to have some coastlines. For this we have to go beyond what Xarray’s built-in plotting can acheive and use the Cartopy package:\n\nimport cartopy.crs as ccrs # the set of map projections cartopy supports\nimport cartopy as cp # the full cartopy package\n\nPassing the projection ‘key-word argument’ to the plotting function tells the plotting library to invoke cartopy to draw the plot using a given map projection. Here we are using the ‘OSGB’ map projection (a cartesian grid, in other words a flat plane approximation that ignores the curvature of the earth) which a lot of UK hydrological data will be on. For any data that is on a ‘lon/lat’ grid instead of an ‘x/y’ grid, the ccrs.PlateCarree() projection is a better option.\n\nplot1 = plotpoint.plot.pcolormesh(cmap='Blues', robust=True, subplot_kws=dict(projection=ccrs.OSGB())) # create the initial plot\nplt.title(r'Rainfall $2^{nd}$ Jan 1990 12:00')\nplot1.axes.coastlines() # add coastlines\ngl = plot1.axes.gridlines(draw_labels=True, alpha=0.5) # add gridlines. The alpha parameter is the transparency between 0 and 1.\ngl.top_labels = False\ngl.right_labels = False # remove the top and right gridlines labels to make the plot look nicer"
  },
  {
    "objectID": "ss3.html#further-resources",
    "href": "ss3.html#further-resources",
    "title": "Part 3: Exploring remotely-stored Zarr datasets using Xarray",
    "section": "Further Resources",
    "text": "Further Resources\n\nXarray documentation\nXarray “common usage patterns” tutorial\nDask documentation\nDask tutorial\nFSSpec documentation\nPangeo tutorial gallery\nObject storage tutorial\n2024 Summer School workshop notebook 1, focusing more on NetCDF\n2024 Summer School workshop notebook 2, focusing more on Zarr"
  },
  {
    "objectID": "ql.html",
    "href": "ql.html",
    "title": "Quarto Live Example",
    "section": "",
    "text": "This page demonstrates how to use Quarto Live"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "FDRI Gridded Data",
    "section": "",
    "text": "This is a Quarto website.\nTo learn more about Quarto websites visit https://quarto.org/docs/websites."
  }
]